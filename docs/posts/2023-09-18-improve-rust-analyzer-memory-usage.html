<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A little tip to improve rust-analyzer memory usage - Bitestring's Blog</title>
  <link rel="stylesheet" href="../css/bootstrap-5.2.0.min.css">
  <link rel="stylesheet" href="../css/default.css">
  <link rel="stylesheet" href="../css/syntax.css">
</head>

<body>
  <div class="container p-4">
    <header class="text-center site-header">
      <a class="fw-bold fs-5 text-dark" href="../">Bitestring's Blog</a>

      <div class="d-flex justify-content-center my-md-3">
        <nav class="nav flex-column flex-md-row my-3 my-md-auto">
          <a class="nav-link" href="../">Posts</a>
          <a class="nav-link" href="../about.html">About</a>
          <a class="nav-link" href="../atom.xml">Atom</a>
          <a class="nav-link" href="../rss.xml">RSS</a>
        </nav>
      </div>
    </header>

    <main class="my-4" role="main">
      <h1>A little tip to improve rust-analyzer memory usage</h1>
      <article>
    <section class="header fst-italic my-3">
        Posted on September 18, 2023
    </section>
    <section>
        <p><em><strong>Note: I am new to Rust, so please pardon me if I am doing something stupid.</strong></em></p>
<p><a href="https://rust-analyzer.github.io/">rust-analyzer</a> is an excellent companion when you are writing Rust code. If you don’t know what rust-analyzer is, it is the engine or LSP Server that powers editors like VSCode (or VSCodium), Emacs, Vim etc. to help you write Rust with auto-completion, debugging and refactoring support.</p>
<p>However, it is one of the worst offenders when it comes to memory efficiency. It sucks up more memory than all Electron apps combined. You can do a <a href="https://github.com/rust-lang/rust-analyzer/issues?q=is%3Aissue+memory+usage">quick search on GitHub</a> which reveals how common this issue is.</p>
<p>On one of my projects I had to generate some FFI bindings to some C code using <a href="https://rust-lang.github.io/rust-bindgen/">bindgen</a>. FFI bindings are generated by using <a href="https://rust-lang.github.io/rust-bindgen/tutorial-3.html">build.rs</a> file. Every time I do <code>cargo build</code>, bindings are generated. Then I consume these bindings in my Rust code.</p>
<p>The structure of my code looks something like this</p>
<pre class="example"><code>build.rs
Cargo.lock
Cargo.toml
src/
    main.rs
    lib.rs
wrapper.h
</code></pre>
<p><code>build.rs</code> consumes <code>wrapper.h</code> to generate bindings which are then included in <code>src/lib.rs</code>.</p>
<p>Pretty simple, right? However, rust-analyzer does not like this setup. If I opened this project in an editor, it would pile up the memory and eventually crash my VM. I tried VSCode and Emacs with lsp-mode. Nothing worked. It seems that there is a serious memory leak bug in rust-analyzer. However, this did not happen on a simple hello-world project. So I suspected this could be due to bindings being generated during <code>cargo build</code> or <code>cargo check</code>.</p>
<p>Then I read about <a href="https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html">Cargo Workspaces</a> which is a feature in Cargo to split a bigger crate into multiple packages and link them through a master <code>Cargo.toml</code> file. I thought about whether this would help with my situation.</p>
<p>I separated the binding generation part and the consuming part into two packages using Cargo Workspaces. Surprisingly it worked! rust-analyzer stopped piling up the memory. I still don’t know the root cause for the memory leaks, but at least I am able to use my VM and write some code.</p>
<p>The new project structure looks like this</p>
<pre class="example"><code>Cargo.lock
Cargo.toml
bindings-package/
    src/
        lib.rs	  
    build.rs
    Cargo.toml
    wrapper.h
consumer-package/
    src/
        main.rs
    Cargo.toml
</code></pre>
<p>This structure also improved <code>cargo build</code> time. If you are facing high memory usage with rust-analyzer when using FFI bindings or a heavier <code>build.rs</code> script, try splitting your bindings into a separate package. It might help you.</p>
    </section>
</article>

    </main>

    <footer class="py-4 text-center text-muted border-top">
      <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width: 0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is
      licensed under a
      <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike
        4.0 International License</a>.
    </footer>
  </div>
</body>

</html>